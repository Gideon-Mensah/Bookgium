{% extends 'base.html' %}
{% load static %}

{% block title %}AI Assistant - Bookgium{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 600px;
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
    }
    
    .message {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 0.375rem;
        max-width: 80%;
    }
    
    .message.user {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
    }
    
    .message.assistant {
        background-color: white;
        border: 1px solid #dee2e6;
        margin-right: auto;
    }
    
    .suggestions {
        margin-bottom: 1rem;
    }
    
    .suggestion-button {
        margin: 0.25rem;
        cursor: pointer;
    }
    
    .typing-indicator {
        display: none;
        padding: 0.5rem;
        font-style: italic;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-robot me-2"></i>
                        Bookgium AI Assistant
                    </h5>
                    <small class="text-muted">Ask me anything about accounting or using Bookgium</small>
                </div>
                
                <div class="card-body">
                    <!-- Contextual Help Suggestions -->
                    <div class="suggestions mb-3">
                        <h6>Quick Help:</h6>
                        <div id="suggestion-buttons"></div>
                    </div>
                    
                    <!-- Chat Container -->
                    <div class="chat-container">
                        <div class="chat-messages" id="chat-messages">
                            <div class="message assistant">
                                <strong>AI Assistant:</strong><br>
                                Hello! I'm your Bookgium AI assistant. I can help you with:
                                <ul class="mt-2 mb-0">
                                    <li>Accounting concepts and principles</li>
                                    <li>How to use Bookgium features</li>
                                    <li>Troubleshooting common issues</li>
                                    <li>Best practices for bookkeeping</li>
                                </ul>
                                What would you like to know?
                            </div>
                        </div>
                        
                        <div class="typing-indicator" id="typing-indicator">
                            AI is typing...
                        </div>
                        
                        <!-- Input Form -->
                        <form id="chat-form">
                            <div class="input-group">
                                <input type="text" 
                                       class="form-control" 
                                       id="question-input" 
                                       placeholder="Ask me anything about accounting or Bookgium..."
                                       required>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const chatMessages = $('#chat-messages');
    const questionInput = $('#question-input');
    const typingIndicator = $('#typing-indicator');
    
    // Load contextual help suggestions
    loadContextualHelp();
    
    // Handle form submission
    $('#chat-form').on('submit', function(e) {
        e.preventDefault();
        
        const question = questionInput.val().trim();
        if (!question) return;
        
        // Add user message
        addMessage('user', question);
        
        // Clear input
        questionInput.val('');
        
        // Show typing indicator
        showTyping(true);
        
        // Send to AI
        sendToAI(question);
    });
    
    // Handle suggestion clicks
    $(document).on('click', '.suggestion-button', function() {
        const question = $(this).text();
        questionInput.val(question);
        $('#chat-form').submit();
    });
    
    function addMessage(type, content) {
        const messageHtml = `
            <div class="message ${type}">
                <strong>${type === 'user' ? 'You' : 'AI Assistant'}:</strong><br>
                ${content.replace(/\n/g, '<br>')}
            </div>
        `;
        
        chatMessages.append(messageHtml);
        chatMessages.scrollTop(chatMessages[0].scrollHeight);
    }
    
    function showTyping(show) {
        if (show) {
            typingIndicator.show();
        } else {
            typingIndicator.hide();
        }
        chatMessages.scrollTop(chatMessages[0].scrollHeight);
    }
    
    function sendToAI(question) {
        $.ajax({
            url: '{% url "ai_assistant:chat_api" %}',
            method: 'POST',
            data: JSON.stringify({
                question: question,
                current_page: getCurrentPage()
            }),
            contentType: 'application/json',
            success: function(response) {
                showTyping(false);
                
                if (response.success) {
                    addMessage('assistant', response.response);
                } else {
                    addMessage('assistant', 'Sorry, I encountered an error: ' + response.error);
                }
            },
            error: function() {
                showTyping(false);
                addMessage('assistant', 'Sorry, I\'m having trouble connecting right now. Please try again.');
            }
        });
    }
    
    function loadContextualHelp() {
        $.ajax({
            url: '{% url "ai_assistant:contextual_help" %}',
            data: {
                page: getCurrentPage()
            },
            success: function(response) {
                if (response.success) {
                    const buttonsHtml = response.suggestions.map(suggestion => 
                        `<button class="btn btn-sm btn-outline-secondary suggestion-button">${suggestion}</button>`
                    ).join(' ');
                    
                    $('#suggestion-buttons').html(buttonsHtml);
                }
            }
        });
    }
    
    function getCurrentPage() {
        // Try to determine current page from URL
        const path = window.location.pathname;
        if (path.includes('/accounts/')) return 'accounts';
        if (path.includes('/invoices/')) return 'invoices';
        if (path.includes('/reports/')) return 'reports';
        if (path.includes('/journal/')) return 'journal_entries';
        return 'general';
    }
});
</script>
{% endblock %}
