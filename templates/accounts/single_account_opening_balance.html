{% extends 'base.html' %}
{% load static %}

{% block title %}{{ account.name }} - Opening Balance{% endblock %}

{% block extra_css %}
<style>
    .account-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 0.375rem;
        margin-bottom: 2rem;
    }
    
    .balance-form {
        max-width: 500px;
        margin: 0 auto;
    }
    
    .current-balance {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.375rem;
        border: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Account Header -->
    <div class="account-header">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="h2 mb-2">
                    <i class="fas fa-balance-scale me-2"></i>
                    Opening Balance
                </h1>
                <p class="mb-0">
                    <strong>{{ account.code }} - {{ account.name }}</strong>
                    <br>
                    <span class="badge bg-light text-dark">{{ account.get_account_type_display }}</span>
                </p>
            </div>
            <div class="col-auto">
                <a href="{% url 'accounts:opening_balance_management' %}" class="btn btn-light">
                    <i class="fas fa-arrow-left me-1"></i>
                    Back to Management
                </a>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- Current Balance Info -->
            <div class="current-balance mb-4">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-0">Current Opening Balance</h5>
                        <h2 class="mb-0 {% if account.opening_balance > 0 %}text-success{% elif account.opening_balance < 0 %}text-danger{% else %}text-muted{% endif %}">
                            {{ currency_symbol }}{{ account.opening_balance|floatformat:2 }}
                        </h2>
                        {% if account.opening_balance_date %}
                        <small class="text-muted">Date: {{ account.opening_balance_date|date:"F d, Y" }}</small>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <h6>Current Account Balance</h6>
                        <h4 class="{% if account.balance > 0 %}text-success{% elif account.balance < 0 %}text-danger{% else %}text-muted{% endif %}">
                            {{ currency_symbol }}{{ account.balance|floatformat:2 }}
                        </h4>
                        <small class="text-muted">
                            Includes opening balance + transactions
                        </small>
                    </div>
                </div>
            </div>

            <!-- Edit Form -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-edit me-2"></i>
                        Update Opening Balance
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" class="balance-form" id="opening-balance-form">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label for="{{ form.opening_balance.id_for_label }}" class="form-label">
                                Opening Balance
                            </label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text">{{ currency_symbol }}</span>
                                {{ form.opening_balance }}
                            </div>
                            {% if form.opening_balance.errors %}
                            <div class="text-danger mt-2">
                                {% for error in form.opening_balance.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-4">
                            <label for="{{ form.opening_balance_date.id_for_label }}" class="form-label">
                                Opening Balance Date
                            </label>
                            {{ form.opening_balance_date }}
                            {% if form.opening_balance_date.errors %}
                            <div class="text-danger mt-2">
                                {% for error in form.opening_balance_date.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Information Panel -->
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>Account Type Information</h6>
                            <p class="mb-0">
                                {% if account.account_type == 'asset' %}
                                    <strong>Assets:</strong> Positive balances represent resources owned by the business (cash, inventory, equipment).
                                {% elif account.account_type == 'liability' %}
                                    <strong>Liabilities:</strong> Positive balances represent amounts owed to creditors (loans, accounts payable).
                                {% elif account.account_type == 'equity' %}
                                    <strong>Equity:</strong> Positive balances represent owner's stake in the business.
                                {% elif account.account_type == 'income' %}
                                    <strong>Income/Revenue:</strong> Positive balances represent earnings from business operations.
                                {% elif account.account_type == 'expense' %}
                                    <strong>Expenses:</strong> Positive balances represent costs incurred in business operations.
                                {% endif %}
                            </p>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>
                                Update Opening Balance
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                <i class="fas fa-undo me-1"></i>
                                Reset to Current Value
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Related Information -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6><i class="fas fa-history me-2"></i>Recent Activity</h6>
                            <p class="mb-0">
                                <small class="text-muted">
                                    Account created: {{ account.created_at|date:"M d, Y" }}
                                    <br>
                                    Last updated: {{ account.updated_at|date:"M d, Y H:i" }}
                                </small>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6><i class="fas fa-link me-2"></i>Quick Actions</h6>
                            <div class="d-grid gap-1">
                                <a href="{% url 'accounts:account_detail' account.pk %}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye me-1"></i>View Account Details
                                </a>
                                <a href="{% url 'accounts:account_statement' account.pk %}" class="btn btn-sm btn-outline-info">
                                    <i class="fas fa-file-alt me-1"></i>Account Statement
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let originalBalance = '{{ account.opening_balance|floatformat:2 }}';
    let originalDate = '{{ account.opening_balance_date|date:"Y-m-d" }}';
    
    function resetForm() {
        $('[name="opening_balance"]').val(originalBalance);
        $('[name="opening_balance_date"]').val(originalDate);
    }
    
    $(document).ready(function() {
        // Format balance input as user types
        $('[name="opening_balance"]').on('input', function() {
            let value = $(this).val();
            if (value && !isNaN(value)) {
                // Update display or perform validation if needed
            }
        });
        
        // Form submission
        $('#opening-balance-form').on('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            $.ajax({
                url: window.location.href,
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        // Show success message
                        $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                          '<i class="fas fa-check-circle me-2"></i>' +
                          'Opening balance updated successfully!' +
                          '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                          '</div>').prependTo('.container-fluid');
                        
                        // Update the current balance display
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        // Show error messages
                        let errorHtml = '<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                                       '<i class="fas fa-exclamation-circle me-2"></i>' +
                                       'Please correct the following errors:<ul class="mb-0">';
                        
                        for (let field in response.errors) {
                            response.errors[field].forEach(error => {
                                errorHtml += '<li>' + error + '</li>';
                            });
                        }
                        
                        errorHtml += '</ul><button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
                        
                        $('<div>').html(errorHtml).prependTo('.container-fluid');
                    }
                },
                error: function() {
                    $('<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                      '<i class="fas fa-exclamation-circle me-2"></i>' +
                      'An error occurred while updating the opening balance.' +
                      '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                      '</div>').prependTo('.container-fluid');
                }
            });
        });
    });
</script>
{% endblock %}
