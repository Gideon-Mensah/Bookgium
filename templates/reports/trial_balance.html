{% extends 'base.html' %}
{% load static %}

{% block title %}Trial Balance - Reports{% endblock %}
{% block page_title %}Trial Balance{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/print.css' %}">
{% endblock %}

{% block content %}
<!-- Screen-only controls -->
<div class="row mb-4 screen-only">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h3>Trial Balance</h3>
                <p class="text-muted mb-0">As of {{ date_from|date:"F d, Y" }} to {{ date_to|date:"F d, Y" }}</p>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary" onclick="window.print()">
                    <i class="fas fa-print me-1"></i>Print
                </button>
                <button type="button" class="btn btn-outline-success" onclick="exportToExcel()">
                    <i class="fas fa-file-excel me-1"></i>Excel
                </button>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filtersModal">
                    <i class="fas fa-filter me-1"></i>Filters
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Print-only header -->
<div class="report-header print-only">
    <div class="company-name">Bookgium</div>
    <div class="report-title">Trial Balance</div>
    <div class="report-period">For the period from {{ date_from|date:"F d, Y" }} to {{ date_to|date:"F d, Y" }}</div>
</div>

{% if not is_balanced %}
<div class="alert alert-warning screen-only" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <strong>Warning:</strong> The trial balance does not balance. Total debits ({{ currency_symbol }}{{ total_debits|floatformat:2 }}) 
    do not equal total credits ({{ currency_symbol }}{{ total_credits|floatformat:2 }}). Please review your accounts.
</div>
{% endif %}

<div class="alert alert-info screen-only" role="alert">
    <i class="fas fa-info-circle me-2"></i>
    <strong>Tip:</strong> Click on any account row to view its detailed statement and transaction history.
</div>

<div class="card shadow">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="trialBalanceTable">
                <thead class="table-dark">
                    <tr>
                        <th>Account Code</th>
                        <th>Account Name</th>
                        <th>Account Type</th>
                        <th class="text-end">Debit Balance</th>
                        <th class="text-end">Credit Balance</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in trial_balance_data %}
                    <tr class="clickable-row" data-account-url="{% url 'accounts:account_statement' item.account.id %}" style="cursor: pointer;" title="Click to view account statement" tabindex="0">
                        <td><strong>{{ item.account.code }}</strong></td>
                        <td>
                            {{ item.account.name }}
                            <i class="fas fa-external-link-alt ms-1 text-muted" style="font-size: 0.7em;"></i>
                            <span class="sr-only">Click to view detailed statement</span>
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ item.account.get_account_type_display }}</span>
                        </td>
                        <td class="text-end">
                            {% if item.debit_balance > 0 %}
                                {{ currency_symbol }}{{ item.debit_balance|floatformat:2 }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="text-end">
                            {% if item.credit_balance > 0 %}
                                {{ currency_symbol }}{{ item.credit_balance|floatformat:2 }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">No accounts found for the selected period.</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-dark total-row">
                    <tr>
                        <th colspan="3">TOTALS</th>
                        <th class="text-end">{{ currency_symbol }}{{ total_debits|floatformat:2 }}</th>
                        <th class="text-end">{{ currency_symbol }}{{ total_credits|floatformat:2 }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Filters Modal -->
<div class="modal fade" id="filtersModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Filter Trial Balance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="get">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="date_from" class="form-label">From Date</label>
                                <input type="date" class="form-control" name="date_from" value="{{ date_from|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="date_to" class="form-label">To Date</label>
                                <input type="date" class="form-control" name="date_to" value="{{ date_to|date:'Y-m-d' }}">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function exportToExcel() {
    // Simple CSV export functionality
    let csv = 'Account Code,Account Name,Account Type,Debit Balance,Credit Balance\n';
    
    const table = document.getElementById('trialBalanceTable');
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        if (row.cells.length === 5) {
            const cells = row.cells;
            csv += `"${cells[0].textContent.trim()}","${cells[1].textContent.trim()}","${cells[2].textContent.trim()}","${cells[3].textContent.trim()}","${cells[4].textContent.trim()}"\n`;
        }
    });
    
    // Add totals
    csv += `"","","TOTALS","{{ currency_symbol }}{{ total_debits|floatformat:2 }}","{{ currency_symbol }}{{ total_credits|floatformat:2 }}"`;
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'trial_balance_{{ date_from|date:"Y_m_d" }}_to_{{ date_to|date:"Y_m_d" }}.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Handle clickable rows
document.addEventListener('DOMContentLoaded', function() {
    const clickableRows = document.querySelectorAll('.clickable-row');
    
    clickableRows.forEach(row => {
        // Handle mouse clicks
        row.addEventListener('click', function() {
            const url = this.getAttribute('data-account-url');
            if (url) {
                window.location.href = url;
            }
        });
        
        // Handle keyboard navigation (Enter and Space)
        row.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const url = this.getAttribute('data-account-url');
                if (url) {
                    window.location.href = url;
                }
            }
        });
        
        // Add focus styles
        row.addEventListener('focus', function() {
            this.style.outline = '2px solid #007bff';
            this.style.outlineOffset = '-2px';
        });
        
        row.addEventListener('blur', function() {
            this.style.outline = '';
            this.style.outlineOffset = '';
        });
    });
});

// Print styles
window.addEventListener('beforeprint', function() {
    document.body.classList.add('printing');
});

window.addEventListener('afterprint', function() {
    document.body.classList.remove('printing');
});
</script>

<style>
@media print {
    .btn-group,
    .modal,
    .modal-backdrop {
        display: none !important;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    
    .table {
        font-size: 12px;
    }
    
    body.printing {
        -webkit-print-color-adjust: exact;
    }
    
    .fa-external-link-alt {
        display: none !important;
    }
    
    .clickable-row {
        cursor: default !important;
    }
}

.table th {
    border-top: none;
}

.badge {
    font-size: 0.7em;
}

.clickable-row {
    transition: all 0.2s ease;
}

.clickable-row:hover {
    background-color: #f8f9fe !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.clickable-row:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.clickable-row:focus {
    background-color: #e3f2fd !important;
    outline: 2px solid #2196f3 !important;
    outline-offset: -2px;
}

/* Screen reader text for accessibility */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}
</style>
{% endblock %}
